---
title: "Split-Treat Data Preparation"
author: "Dan Aurell"
date: "2023-10-27"
output:   
  html_document: 
    keep_md: yes
---


# Workflow 

## What data do I have from the app?

App data - d77
-
Shaw 5/24/2022
Wire 5/31/2022
Shooting Range 6/7/2022
Turfgrass 6/11/2022

Post-harvest - no app data
-
Shaw 7/1/2022
Wire 7/2/2022
Shooting Range 7/2/2022
Turfgrass 7/2/2022




# Setup

```{r}
library(tidyverse)
library(lme4)
library(stringr)
```


# Read in data

## Read csv
```{r}
paper <- read.csv("./data/manual_merge_paper_2023-05-23.csv")
colony <- read.csv("./data/2022-06-14_125633__techteam__all_sample_export.csv", skip = 9, na.strings = c("", " ", "NA"))
frame <- read.csv("./data/2022-06-14_125650__techteam__frame_side_export.csv")


```

## Pare down and rename columns

Paper data
```{r}
paper <- paper %>% 
  rename(colony_num = split_ids)
```

Frame-level data
```{r}

frame2 <- frame %>% 
  rename(
    project = frame__box__sample__sample_event__project,  
    colony_num = frame__box__sample__colony_num,
    date = frame__box__sample__sample_event__collection_date,
    box_num = frame__box__box_number,
    box_size = frame__box__size,
    frame_num = frame__frame_number,
    side = side_name,
    bees = bee_coverage,
    cap_wk = capped_worker_brood_coverage,
    cap_dr = capped_drone_brood_coverage,
    honey = honey_coverage,
    pollen = pollen_coverage,
    extra_bees = frame__box__bee_coverage,
    inspection_order = frame__box__sample__inspection_order
         )


frame2 <- frame2 %>% 
  select(
        project,
    colony_num,
    date,
    box_num,
    box_size,
    frame_num,
    side,
    bees,
    cap_wk,
    cap_dr,
    honey,
    pollen,
    extra_bees,
    inspection_order,
         id,
         frame,
         notes
         )

frame2 <- frame2 %>% 
  filter(date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) 


# Quality control
unique(frame2$colony_num)

 frame2 %>% 
  group_by(date, colony_num) %>% 
  summarize(n = n()) %>% 
   arrange(desc(n))

```
## Deal with "extra bees"
```{r}
frame2 %>% 
  group_by(date, colony_num) %>% 
  summarize(n = n()) # There are 36-72 rows per colony and date


frame2$extra_bees_temp <- frame2$extra_bees # clone column
frame2$extra_bees <- NA # Erase the values in original column

frame2 <- frame2 %>% 
  mutate(extra_bees = ifelse(frame_num == 1 & side == "A", extra_bees_temp, NA)) %>% 
  select(-extra_bees_temp)

# Replace NA with 0
frame2$bees[is.na(frame2$bees)] <- 0
frame2$extra_bees[is.na(frame2$extra_bees)] <- 0

# Replace 2520 with 25
frame2$bees[frame2$bees == 2520] <- 0

frame2 <- frame2 %>% 
  mutate(bees_total = bees + extra_bees)

```


Correct for different box/frame sizes
```{r}
# Convert to Deep-frame equivalents
frame2 <- frame2 %>% mutate(
  conversion = ifelse(box_size == "Medium", 0.64, 1)
)

names(frame2)

# append "_C" to a column to mean converted
frame2 <- frame2 %>% 
  mutate(
    bees_C = bees*conversion,
    cap_wk_C = cap_wk*conversion,
    cap_dr_C = cap_dr*conversion,
    honey_C = honey*conversion,
    pollen_C = pollen*conversion
  )
```

## Summarize per colony
```{r}
resources <- frame2 %>% 
  group_by(colony_num) %>% 
  # 100 would mean that there is one complete side of bees
  
  # Divide by 100 to get "sides"
  # Then divide by 2 to get "frames"

  # In total, divide by 200
  
  summarise(
    frames_bees = sum(bees_C, na.rm = TRUE)/200,
    frames_wbr = sum(cap_wk_C, na.rm = TRUE)/200,
    frames_dbr = sum(cap_dr_C, na.rm = TRUE)/200,
    frames_honey = sum(honey_C, na.rm = TRUE)/200
    )
```


Colony-level data
```{r}

names(colony)

colony2 <- colony %>% 
  select(sample_event__project,
         sample_event__collection_date,
         colony_num,
         deeps_num,
         mediums_num,
         threequarters_num,
         shallows_num,
         supers_num,
         queen_status,
         frames_of_bees,
         efb_observed
         ) %>% 
  rename(project = sample_event__project,
         collection_date = sample_event__collection_date
         )
```



# Understand data

How to identify just relevant app data for day 77
"colony" and "frame" are the colony and frame level app data
```{r}
unique(colony$project)

pattern <- "date"
  grep(pattern, names(colony), value=TRUE)  

pattern <- "coverage"
  grep(pattern, names(frame), value=TRUE)  
  
unique(colony$collection_date)
```

# Prep data 

## Prep colony level app data
```{r}
# Colony2 is just selected and renamed

colony2 %>% 
  filter(collection_date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) %>% 
  group_by(collection_date, colony_num) %>% 
  summarize(n())

# colony3 is filtered to the data of interest
colony3 <- colony2 %>% 
  filter(collection_date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) %>% 
  filter(!is.na(queen_status)) %>% 
  arrange(colony_num)

unique(colony3$colony_num) #138 including the blank space
# But a few duplicated colonies exist

# Replace 21-043 with 22-043
colony3$colony_num[colony3$colony_num == "21-034"] <- "22-034"

# focus on queen status and efb columns
colony4 <- colony3 %>% 
  select(colony_num, queen_status, efb_observed)

# Rename queen status and efb columns
colony4 <- colony4 %>% 
  rename(ch77_qstatus = queen_status,
         ch77_efb = efb_observed
         )


# Remove duplicate rows introduced by the app
colony4 <- colony4[!duplicated(colony4[, 1]), ]

# "pa" means "paper_app"
pa <- left_join(paper, colony4)

pa <- pa %>% 
  mutate(
    trt_label = if_else(trt == "1-Control", "Control",
              if_else(trt == "2-Apivar", "Apivar",
                    if_else(trt == "4-Dribble18", "OA Dribble", 
                            if_else(trt == "6-ManyDribble", "5x OA Dribble",
                                   if_else(trt == "5-Vapor18", "OA Vapor",
                                           if_else(trt == "7-HopGuard", "HopGuard",
                                                   if_else(trt == "3-Taktic", "Amitraz E.C.", "NA"
                                                           )
                                                   )))))))

pa <- pa %>%
     mutate(trt_label = fct_relevel(trt_label, "Control", "Apivar", "Amitraz E.C.", "OA Dribble", "5x OA Dribble", "OA Vapor", "HopGuard"))

```

## Prep pa data

Tag colonies that had EFB by day 77
```{r}

pa$efb_columns <- paste(
  pa$reason_removal, 
  pa$ch77_efb # This did not add any additional ones
  )

pa$efb <- ifelse(grepl("EFB", pa$efb_columns), 1, 0)



# Number of EFB colonies per treatment
pa %>%
  filter(efb == 1) %>% 
  group_by(trt) %>% 
  summarize(n = n()) # Very even across groups
```

Determine queen issues including day 77
```{r}
# Survival to day 77 - assess based on absence of other issues

# Number of queen events per treatment up to and including day 72

# failed to mate
  # look in column reason_removal
# drone layer
# queenless
  # If QL or DL present in columns ch44_qstatus, ch58_qstatus, ch72_qstatus, 


pa$qstatuses <- paste(
  pa$ch44_qstatus, 
  pa$ch58_qstatus, 
  pa$ch72_qstatus, 
  pa$ch77_qstatus,
  pa$reason_removal
  )

pa$failed <- ifelse(grepl("Failed", pa$reason_removal), 1, 0)
pa$weak <- ifelse(grepl("Weak|Small", pa$reason_removal), 1, 0)
pa$QL <- ifelse(grepl("QL|VS|VQS|VQ", pa$qstatuses), 1, 0)
pa$DL <- ifelse(grepl("DL", pa$qstatuses), 1, 0)

pa <- pa %>% 
  mutate(died = ifelse(failed + weak + QL + DL > 0, 1, 0),
         survived = ifelse(failed + weak + QL + DL == 0, 1, 0)
         )


```

## Add resources data to pa data
```{r}
pa <- left_join(pa, resources)
```

Correct the hive weight based on the number of supers and 11 lbs per super
```{r}
pa <- pa %>% 
  mutate(post_lbs_C = post_lbs - 11*(post_supers_use-1))
```



# Write an_dat for use in future steps
```{r}
an_dat <- pa

write.csv(an_dat, "../2_Analysis/data_prepared/an_dat.csv")
```


