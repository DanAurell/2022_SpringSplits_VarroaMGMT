---
title: "Split-Treat Data Preparation"
author: "Dan Aurell"
date: "2023-10-27"
output:   
  html_document: 
    keep_md: yes
---


test of push to GitHub

# Workflow 

## What data do I have from the app?

App data - d77
-
Shaw 5/24/2022
Wire 5/31/2022
Shooting Range 6/7/2022
Turfgrass 6/11/2022

Post-harvest - no app data
-
Shaw 7/1/2022
Wire 7/2/2022
Shooting Range 7/2/2022
Turfgrass 7/2/2022




# Setup

```{r}
library(tidyverse)
library(lme4)
library(stringr)
```


# Read in data

## Read csv

```{r}
paper <- read.csv("./data/manual_merge_paper_2023-05-23.csv")
colony <- read.csv("./data/2022-06-14_125633__techteam__all_sample_export.csv", skip = 9, na.strings = c("", " ", "NA"))
frame <- read.csv("./data/2022-06-14_125650__techteam__frame_side_export.csv")


```

## Pare down and rename columns

Paper data

```{r}
paper <- paper %>% 
  rename(colony_num = split_ids)
```






Frame-level data
```{r}

frame2 <- frame %>% 
  rename(
    project = frame__box__sample__sample_event__project,  
    colony_num = frame__box__sample__colony_num,
    date = frame__box__sample__sample_event__collection_date,
    box_num = frame__box__box_number,
    box_size = frame__box__size,
    frame_num = frame__frame_number,
    side = side_name,
    bees = bee_coverage,
    cap_wk = capped_worker_brood_coverage,
    cap_dr = capped_drone_brood_coverage,
    honey = honey_coverage,
    pollen = pollen_coverage,
    extra_bees = frame__box__bee_coverage,
    inspection_order = frame__box__sample__inspection_order
         )


frame2 <- frame2 %>% 
  select(
        project,
    colony_num,
    date,
    box_num,
    box_size,
    frame_num,
    side,
    bees,
    cap_wk,
    cap_dr,
    honey,
    pollen,
    extra_bees,
    inspection_order,
         id,
         frame,
         notes
         )

frame2 <- frame2 %>% 
  filter(date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) 


# Quality control
unique(frame2$colony_num)

 frame2 %>% 
  group_by(date, colony_num) %>% 
  summarize(n = n()) %>% 
   arrange(desc(n))

```
## Deal with "extra bees"

```{r}
frame2 %>% 
  group_by(date, colony_num) %>% 
  summarize(n = n()) # There are 36-72 rows per colony and date


frame2$extra_bees_temp <- frame2$extra_bees # clone column
frame2$extra_bees <- NA # Erase the values in original column

frame2 <- frame2 %>% 
  mutate(extra_bees = ifelse(frame_num == 1 & side == "A", extra_bees_temp, NA)) %>% 
  select(-extra_bees_temp)

# Replace NA with 0
frame2$bees[is.na(frame2$bees)] <- 0
frame2$extra_bees[is.na(frame2$extra_bees)] <- 0

# Replace 2520 with 25
frame2$bees[frame2$bees == 2520] <- 0

frame2 <- frame2 %>% 
  mutate(bees_total = bees + extra_bees)

```


Correct for different box/frame sizes
```{r}
# Convert to Deep-frame equivalents
frame2 <- frame2 %>% mutate(
  conversion = ifelse(box_size == "Medium", 0.64, 1)
)

names(frame2)

# append "_C" to a column to mean converted
frame2 <- frame2 %>% 
  mutate(
    bees_C = bees*conversion,
    cap_wk_C = cap_wk*conversion,
    cap_dr_C = cap_dr*conversion,
    honey_C = honey*conversion,
    pollen_C = pollen*conversion
  )
```

## Summarize per colony
```{r}
resources <- frame2 %>% 
  group_by(colony_num) %>% 
  # 100 would mean that there is one complete side of bees
  
  # Divide by 100 to get "sides"
  # Then divide by 2 to get "frames"

  # In total, divide by 200
  
  summarise(
    frames_bees = sum(bees_C, na.rm = TRUE)/200,
    frames_wbr = sum(cap_wk_C, na.rm = TRUE)/200,
    frames_dbr = sum(cap_dr_C, na.rm = TRUE)/200,
    frames_honey = sum(honey_C, na.rm = TRUE)/200
    )
```


Colony-level data
```{r}

names(colony)

colony2 <- colony %>% 
  select(sample_event__project,
         sample_event__collection_date,
         colony_num,
         deeps_num,
         mediums_num,
         threequarters_num,
         shallows_num,
         supers_num,
         queen_status,
         frames_of_bees,
         efb_observed
         ) %>% 
  rename(project = sample_event__project,
         collection_date = sample_event__collection_date
         )
```



# Understand data

How to identify just relevant app data for day 77
```{r}
unique(colony$project)

pattern <- "date"
  grep(pattern, names(colony), value=TRUE)  

pattern <- "coverage"
  grep(pattern, names(frame), value=TRUE)  
  
  
unique(colony$collection_date)
  
```

# Prep data 

## Prep paper data






## Prep colony level app data

```{r}
# Colony2 is just selected and renamed

colony2 %>% 
  filter(collection_date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) %>% 
  group_by(collection_date, colony_num) %>% 
  summarize(n())

# colony3 is filtered to the data of interest

colony3 <- colony2 %>% 
  filter(collection_date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) %>% 
  filter(!is.na(queen_status)) %>% 
  arrange(colony_num)

unique(colony3$colony_num) #138 including the blank space
# But a few duplicated colonies exist

# Replace 21-043 with 22-043
colony3$colony_num[colony3$colony_num == "21-034"] <- "22-034"

# focus on queen status and efb columns
colony4 <- colony3 %>% 
  select(colony_num, queen_status, efb_observed)

# Rename queen status and efb columns

colony4 <- colony4 %>% 
  rename(ch77_qstatus = queen_status,
         ch77_efb = efb_observed
         )

# Remove duplicate rows introduced by the app
colony4 <- colony4[!duplicated(colony4[, 1]), ]


paper <- left_join(paper, colony4)


paper <- paper %>% 
  mutate(
    trt_label = if_else(trt == "1-Control", "Control",
              if_else(trt == "2-Apivar", "Apivar",
                    if_else(trt == "4-Dribble18", "OA Dribble", 
                            if_else(trt == "6-ManyDribble", "5x OA Dribble",
                                   if_else(trt == "5-Vapor18", "OA Vapor",
                                           if_else(trt == "7-HopGuard", "HopGuard",
                                                   if_else(trt == "3-Taktic", "Amitraz E.C.", "NA"
                                                           )
                                                   )))))))

paper <- paper %>%
     mutate(trt_label = fct_relevel(trt_label, "Control", "Apivar", "Amitraz E.C.", "OA Dribble", "5x OA Dribble", "OA Vapor", "HopGuard"))

```

## Paper data 

### Tag colonies that had EFB by day 77

```{r}

paper$efb_columns <- paste(
  paper$reason_removal, 
  paper$ch77_efb # This did not add any additional ones
  )

paper$efb <- ifelse(grepl("EFB", paper$efb_columns), 1, 0)



# Number of EFB colonies per treatment
paper %>%
  filter(efb == 1) %>% 
  group_by(trt) %>% 
  summarize(n = n()) # Very even across groups
```

Determine queen issues including day 77

```{r}
# Survival to day 77 - assess based on absence of other issues

# Number of queen events per treatment up to and including day 72

# failed to mate
  # look in column reason_removal
# drone layer
# queenless
  # If QL or DL present in columns ch44_qstatus, ch58_qstatus, ch72_qstatus, 


paper$qstatuses <- paste(
  paper$ch44_qstatus, 
  paper$ch58_qstatus, 
  paper$ch72_qstatus, 
  paper$ch77_qstatus,
  paper$reason_removal
  )

paper$failed <- ifelse(grepl("Failed", paper$reason_removal), 1, 0)
paper$weak <- ifelse(grepl("Weak|Small", paper$reason_removal), 1, 0)
paper$QL <- ifelse(grepl("QL|VS|VQS|VQ", paper$qstatuses), 1, 0)
paper$DL <- ifelse(grepl("DL", paper$qstatuses), 1, 0)

paper <- paper %>% 
  mutate(died = ifelse(failed + weak + QL + DL > 0, 1, 0),
         survived = ifelse(failed + weak + QL + DL == 0, 1, 0)
         )


```

## Add resources data to paper data

```{r}
paper <- left_join(paper, resources)
```

Correct the hive weight based on the number of supers and 11 lbs per super
```{r}
paper <- paper %>% 
  mutate(post_lbs_C = post_lbs - 11*(post_supers_use-1))
```

Filter out the colonies that had disqualifying issues



```{r}
# Include the 5 colonies that were pulled out for being weak
an_dat <- paper %>% 
  filter(efb + failed + QL + DL == 0)


an_dat$frames_bees[an_dat$weak == 1] <- 0

an_dat$trt

```

## Analyze and plot day 77 Colony strength

```{r}
an_dat %>%
  ggplot(aes(x = trt_label, y = frames_bees)) +
  geom_boxplot(fill = "#031C38", outlier.shape = NA, alpha = 0.6, color = "black") +
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="black", fill="black") +
  #xlab("Treatment") +
  ylab("Frames of bees") +
  theme_classic( base_size = 30) +
  theme(axis.text.x=element_text(angle=45,hjust=1), axis.title.x=element_blank())

ggsave("./2023-11-05 liebefeld_bees v1.png", width = 12, height = 8.625, units = "in")

ggsave("./2023-11-05 liebefeld_bees v2.png", width = 12, height = 6.5, units = "in")

m.bees <- lm(frames_bees~trt, data = an_dat)
summary(m.bees)
summary(aov(m.bees))
anova(m.bees) # No effect of treatment (p=0.9999)
```


```{r}
plot(m.bees)
```


## Analyze and plots the data for colony weight

```{r}
m.weight <- lm(post_lbs_C~trt, data = an_dat)
summary(m.weight)

an_dat %>%
  ggplot(aes(x = trt_label, y = post_lbs_C)) +
  geom_boxplot(fill = "#031C38", outlier.shape = NA, alpha = 0.6, color = "black") +
  stat_summary(fun.y=mean, geom="point", shape=20, size=10, color="black", fill="black") +
  #xlab("Treatment") +
  ylab("Weight (lbs)") +
  theme_classic( base_size = 30) +
  theme(axis.text.x=element_text(angle=45,hjust=1), axis.title.x=element_blank())

ggsave("./2023-11-05 weight v1.png", width = 12, height = 8.625, units = "in")
```



# Which kinds of colony issues were present in how many numbers per group

```{r}
# Failure to mate per treatment - within non-EFB colonies
loss_summary <- paper %>% 
  filter(efb == 0) %>% 
  group_by(trt_label) %>% 
  summarize(n = n(),

            failed_num = sum(failed),
            failed.p = failed_num/n,
            
            weak_num = sum(weak),
            weak.p = weak_num/n,
            
            QL_num = sum(QL),
            QL.p = QL_num/n,
            
            DL_num = sum(DL),
            DL.p = DL_num/n,
            
            died_num = sum(died),
            died.p = died_num/n,
            
            survived_num = sum(survived),
            survived.p = survived_num/n
          )



```



Prep failure type table for graphing
```{r}
loss_summary_pivoted <- loss_summary %>% 
  pivot_longer(c(failed.p, weak.p, QL.p, DL.p), names_to = "reason", values_to = "proportion") 


loss_summary_pivoted <- loss_summary_pivoted %>% 
  mutate(
    reason_label = if_else(reason == "weak.p", "Weak",
                           if_else(reason == "failed.p", "Failed to mate",
                                   if_else(reason == "DL.p", "Drone layer",
                                           if_else(reason == "QL.p", "Queenless", "NA"
                           )
    
    
    ))))

# Relevel factors for plotting

loss_summary_pivoted <- loss_summary_pivoted %>%
     mutate(trt_label = fct_relevel(trt_label, "Control", "Apivar", "Amitraz E.C.", "OA Dribble", "5x OA Dribble", "OA Vapor", "HopGuard"),
            reason_label = fct_relevel(reason_label,"Weak", "Drone layer", "Queenless", "Failed to mate")
            )



```


## To be able to pull out colonies that had certain issues, should I make vectors of colonies with those issues?

- No, I can filter based on the EFB column to make an analytical dataset

```{r}
# Which colonies did I identify as having each issue - make vectors

# EFB

# Weak
weak_colonies <- paper %>% 
  filter(weak == 1)


weak_colonies$split_ids # "22-003" "22-050" "22-058" "22-142" "22-155"

# "22-003" - missing
# "22-050" - missing
# "22-058" - missing
# "22-142" - exists but is quite low 
# "22-155" - missing

```





# Plotting survival and issues

```{r}
# With "weak"

loss_summary_pivoted %>% 
  ggplot(aes(x = trt_label, y = proportion, fill = reason_label)) +
  geom_col(position = "stack") +
  scale_fill_viridis_d(direction = -1) +
  scale_y_continuous(limits = c(0,1)) + 
  ylab("Proportion of colonies") +
  theme_classic(base_size = 30) + 
  theme(axis.text.x=element_text(angle=45,hjust=1), axis.title.x=element_blank(), legend.title = element_blank())
  
ggsave("./2023-11-04 CoD v3.png", width = 12, height = 8.625, units = "in")


# Without "weak"

loss_summary_pivoted %>% 
  filter(reason != "weak.p") %>% 
  ggplot(aes(x = trt_label, y = proportion, fill = reason_label)) +
  geom_col(position = "stack") +
  scale_fill_viridis_d(direction = -1) +
  scale_y_continuous(limits = c(0,1)) + 
  ylab("Proportion of colonies") +
  theme_classic(base_size = 30) + 
  theme(axis.text.x=element_text(angle=45,hjust=1), axis.title.x=element_blank(), legend.title = element_blank())
  
ggsave("./2023-11-04 CoD v5.png", width = 12, height = 8.625, units = "in")


```


Only "weak" colonies


Dan
```{r}

loss_summary %>% 
  ggplot(aes(x = trt_label, y = weak_num)) +
  geom_col() +
  ylab(NULL) +
  scale_y_continuous(breaks = c(0,1,2)) +
  theme_classic(base_size = 30) + 
  theme(axis.text.x=element_text(angle=45,hjust=1), axis.title.x=element_blank(), legend.title = element_blank())

ggsave("./2023-11-05 Count of weak v1.png", width = 12, height = 4, units = "in")
```




# summarize population based on frame level data - into population per colony

## Sum the population per colony in frame level dataset

DANDAN

```{r}

```










# OLD OLD OLD

## Gather info

```{r}
frame2 %>% 
  filter(collection_date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) %>% 
  group_by(collection_date, colony_num) %>% 
  summarize(n=n()) %>% 
  arrange(desc(n))


# Check do some colonies have duplicated rows
frame3 <- frame2 %>% 
  filter(collection_date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) %>% 
  arrange(colony_num)

write.csv(frame3, "frame3.csv")

# There are anywhere from 36 to 72 records per colony - assume that no record was made where the number of bees was 0

# Check how many deep boxes each colony had

frame2 %>% 
  filter(collection_date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) %>% 
  filter(box_size == "Deep") %>% 
  group_by(colony_num, box_num) %>% 
  summarize(n = n()) %>% 
  group_by(colony_num) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n))

# All have 2 Deep boxes except 22-142 which has just one. This is correct... this is the one which was super weak at Turfgrass and was only in one box.

# Check how many Mediums
frame2 %>% 
  filter(collection_date %in% c("2022-05-24", "2022-05-31", "2022-06-07", "2022-06-11")) %>% 
  filter(box_size == "Medium") %>% 
  group_by(colony_num, box_num) %>% 
  summarize(n = n()) %>% 
  group_by(colony_num) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n))

# Only 46 colonies had supers (or at least bees in supers) on Day 77

```



# Make paper data into long format


## Potentially useful code
```{r}
datum2 <- datum %>% 
  filter(!is.na(ch77_var_total)) %>% 
  rename(varroa0 = num_varroa, varroa77 = ch77_var_total)

datum3 <- datum2 %>% pivot_longer(cols = c(varroa0, varroa77), names_to = "day", names_prefix = "varroa", values_to = "varroa")

datum3 <- datum3 %>% 
  mutate(time = ifelse(day == 0, "Before", "After"))
```

## Quickly graph post frames of bees data

```{r}
nonefb %>% 
ggplot(aes(x = trt, y = post_quick_fob)) +
  geom_boxplot()
  
```






# Filter app data

# Merge paper data with app data


# Make a vector of colonies to exclude
Entirely
After a certain date



